openapi: 3.0.3
info:
  title: Todo Chat API
  description: |
    REST API for AI-powered conversational task management.

    This API enables users to manage their todo tasks through natural language
    conversation with an AI assistant. The API integrates with the existing
    Phase II task management system and uses Model Context Protocol (MCP)
    for tool calling.
  version: 1.0.0
  contact:
    name: Evolve Todo App

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.evolve-todo.com
    description: Production server

security:
  - BearerAuth: []

paths:
  /api/{user_id}/chat:
    post:
      summary: Send chat message
      description: |
        Send a message to the AI assistant and receive a response.
        The AI will interpret the message, call appropriate MCP tools,
        and return a natural language response.

        Conversation history is automatically maintained and used for context.
      operationId: sendChatMessage
      tags:
        - Chat
      parameters:
        - name: user_id
          in: path
          required: true
          description: User ID (must match authenticated user)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              createTask:
                summary: Create a task
                value:
                  message: "Add a task to buy groceries tomorrow"
              listTasks:
                summary: List tasks
                value:
                  message: "What do I need to do today?"
              completeTask:
                summary: Complete a task
                value:
                  message: "Mark the first one done"
                  conversation_id: "abc-123-def-456"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                taskCreated:
                  summary: Task created successfully
                  value:
                    response: "I've added 'Buy groceries' to your tasks, due tomorrow. Anything else?"
                    conversation_id: "abc-123-def-456"
                    message_id: "msg-789-ghi"
                    tool_calls:
                      - tool: "add_task"
                        arguments:
                          title: "Buy groceries"
                          due_date: "2026-02-09"
                          priority: "medium"
                        result: "success"
                        task_id: "task-xyz-123"
                tasksList:
                  summary: Tasks listed
                  value:
                    response: "You have 3 tasks due today: 1) Buy groceries 2) Call dentist 3) Submit report"
                    conversation_id: "abc-123-def-456"
                    message_id: "msg-890-jkl"
                    tool_calls:
                      - tool: "list_tasks"
                        arguments:
                          status: "pending"
                          due_date: "today"
                        result: "success"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/{user_id}/chat/history:
    get:
      summary: Get conversation history
      description: |
        Retrieve the conversation history for the authenticated user.
        Returns all messages in chronological order.
      operationId: getChatHistory
      tags:
        - Chat
      parameters:
        - name: user_id
          in: path
          required: true
          description: User ID (must match authenticated user)
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          description: Maximum number of messages to return
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: offset
          in: query
          required: false
          description: Number of messages to skip (for pagination)
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatHistoryResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/{user_id}/chat/clear:
    delete:
      summary: Clear conversation history
      description: |
        Delete all messages in the user's conversation.
        This action cannot be undone.
      operationId: clearChatHistory
      tags:
        - Chat
      parameters:
        - name: user_id
          in: path
          required: true
          description: User ID (must match authenticated user)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation cleared successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Conversation history cleared"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token issued by Better Auth.
        Include in Authorization header: `Bearer <token>`

  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: User's message to the AI assistant
          minLength: 1
          maxLength: 2000
          example: "Add a task to buy groceries tomorrow"
        conversation_id:
          type: string
          format: uuid
          description: |
            Optional conversation ID. If not provided, the user's
            existing conversation will be used or a new one created.
          example: "abc-123-def-456"

    ChatResponse:
      type: object
      required:
        - response
        - conversation_id
        - message_id
      properties:
        response:
          type: string
          description: AI assistant's response
          example: "I've added 'Buy groceries' to your tasks, due tomorrow."
        conversation_id:
          type: string
          format: uuid
          description: Conversation ID (for subsequent messages)
          example: "abc-123-def-456"
        message_id:
          type: string
          format: uuid
          description: Unique ID of the assistant's message
          example: "msg-789-ghi"
        tool_calls:
          type: array
          description: List of MCP tools invoked by the AI
          items:
            $ref: '#/components/schemas/ToolCall'

    ToolCall:
      type: object
      required:
        - tool
        - arguments
        - result
      properties:
        tool:
          type: string
          description: Name of the MCP tool invoked
          enum:
            - add_task
            - list_tasks
            - complete_task
            - update_task
            - delete_task
          example: "add_task"
        arguments:
          type: object
          description: Arguments passed to the tool
          example:
            title: "Buy groceries"
            due_date: "2026-02-09"
            priority: "medium"
        result:
          type: string
          description: Result of the tool invocation
          enum:
            - success
            - error
          example: "success"
        task_id:
          type: string
          format: uuid
          description: Task ID (if applicable)
          example: "task-xyz-123"
        error_message:
          type: string
          description: Error message (if result is 'error')
          example: "Task not found"

    ChatHistoryResponse:
      type: object
      required:
        - conversation_id
        - messages
        - total_count
      properties:
        conversation_id:
          type: string
          format: uuid
          description: Conversation ID
          example: "abc-123-def-456"
        messages:
          type: array
          description: List of messages in chronological order
          items:
            $ref: '#/components/schemas/Message'
        total_count:
          type: integer
          description: Total number of messages in conversation
          example: 42
        has_more:
          type: boolean
          description: Whether there are more messages to fetch
          example: true

    Message:
      type: object
      required:
        - id
        - role
        - content
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Message ID
          example: "msg-123-abc"
        role:
          type: string
          description: Message sender
          enum:
            - user
            - assistant
          example: "user"
        content:
          type: string
          description: Message text
          example: "Add a task to buy groceries tomorrow"
        tool_calls:
          type: object
          description: Tool invocation metadata (assistant messages only)
          nullable: true
        created_at:
          type: string
          format: date-time
          description: Message timestamp
          example: "2026-02-08T10:30:00Z"

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: "UNAUTHORIZED"
        message:
          type: string
          description: Human-readable error message
          example: "Invalid or missing authentication token"
        details:
          type: object
          description: Additional error details
          nullable: true

  responses:
    Unauthorized:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "UNAUTHORIZED"
            message: "Invalid or missing authentication token"

    Forbidden:
      description: User ID in path does not match authenticated user
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "FORBIDDEN"
            message: "You can only access your own chat history"

    RateLimitExceeded:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "RATE_LIMIT_EXCEEDED"
            message: "Too many requests. Please try again in 60 seconds."
      headers:
        X-RateLimit-Limit:
          description: Request limit per minute
          schema:
            type: integer
            example: 60
        X-RateLimit-Remaining:
          description: Remaining requests in current window
          schema:
            type: integer
            example: 0
        X-RateLimit-Reset:
          description: Time when rate limit resets (Unix timestamp)
          schema:
            type: integer
            example: 1707390000

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "An unexpected error occurred. Please try again."

tags:
  - name: Chat
    description: AI-powered conversational task management
